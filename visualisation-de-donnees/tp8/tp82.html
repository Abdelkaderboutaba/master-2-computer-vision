<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Glass Correlogram</title>
</head>
<body>
<div id="container"></div>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script type="module">

function calculateCorrelation(x, y) {
    const n = x.length;
    const meanX = d3.mean(x);
    const meanY = d3.mean(y);
    
    let numerator = 0;
    let denomX = 0;
    let denomY = 0;
    
    for (let i = 0; i < n; i++) {
        const dx = x[i] - meanX;
        const dy = y[i] - meanY;
        numerator += dx * dy;
        denomX += dx * dx;
        denomY += dy * dy;
    }
    
    return numerator / Math.sqrt(denomX * denomY);
}

function correlationMatrix(data, features) {
    const n = features.length;
    const matrix = [];
    
    for (let i = 0; i < n; i++) {
        matrix[i] = [];
        const colI = data.map(row => row[i]);
        
        for (let j = 0; j < n; j++) {
            if (i === j) {
                matrix[i][j] = null;
            } else {
                const colJ = data.map(row => row[j]);
                matrix[i][j] = calculateCorrelation(colI, colJ);
            }
        }
    }
    
    return matrix;
}

d3.csv("glass.csv").then(function(data) {
    
    const features = ['RI', 'Na', 'Mg', 'Al', 'Si', 'K', 'Ca', 'Ba', 'Fe'];
    
    const X = data.map(d => features.map(f => +d[f]));
    
    const corrMatrix = correlationMatrix(X, features);
    
    console.log("Correlation matrix:", corrMatrix);
    
    const width = 800;
    const height = 800;
    const margin = {top: 80, right: 150, bottom: 80, left: 80};
    
    const plotWidth = width - margin.left - margin.right;
    const plotHeight = height - margin.top - margin.bottom;
    
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);
    
    const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
    
    const xFeatures = features.slice(0, -1);
    const yFeatures = features.slice(1).reverse();
    
    const cellWidth = plotWidth / xFeatures.length;
    const cellHeight = plotHeight / yFeatures.length;
    
    const colorScale = d3.scaleLinear()
        .domain([-1, 0, 1])
        .range(["#d73027", "#f7f7f7", "#4575b4"]);
    
    const sizeScale = d3.scaleLinear()
        .domain([0, 1])
        .range([0, Math.min(cellWidth, cellHeight) * 0.4]);
    
    yFeatures.forEach((featureY, i) => {
        const originalIndexY = features.indexOf(featureY);
        
        xFeatures.forEach((featureX, j) => {
            const originalIndexX = features.indexOf(featureX);
            
            if (originalIndexX < originalIndexY) {
                const corr = corrMatrix[originalIndexY][originalIndexX];
                const cx = j * cellWidth + cellWidth / 2;
                const cy = i * cellHeight + cellHeight / 2;
                
                g.append("circle")
                    .attr("cx", cx)
                    .attr("cy", cy)
                    .attr("r", sizeScale(Math.abs(corr)))
                    .attr("fill", colorScale(corr))
                    .attr("stroke", "#333")
                    .attr("stroke-width", 0.5)
                    .attr("opacity", 0.8)
                    .on("mouseover", function(event) {
                        d3.select(this)
                            .attr("stroke-width", 2)
                            .attr("opacity", 1);
                        
                        tooltip
                            .style("display", null)
                            .attr("transform", `translate(${cx + margin.left + 15},${cy + margin.top - 40})`);
                        
                        tooltipText.selectAll("tspan").remove();
                        
                        tooltipText.append("tspan")
                            .attr("x", 10)
                            .attr("dy", 0)
                            .attr("font-weight", "bold")
                            .text(`${featureX} vs ${featureY}`);
                        
                        tooltipText.append("tspan")
                            .attr("x", 10)
                            .attr("dy", 20)
                            .text(`r = ${corr.toFixed(3)}`);
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                            .attr("stroke-width", 0.5)
                            .attr("opacity", 0.8);
                        
                        tooltip.style("display", "none");
                    });
            }
        });
    });
    
    xFeatures.forEach((feature, i) => {
        g.append("text")
            .attr("x", i * cellWidth + cellWidth / 2)
            .attr("y", -10)
            .attr("text-anchor", "middle")
            .attr("font-size", "13px")
            .attr("font-weight", "bold")
            .text(feature);
    });
    
    yFeatures.forEach((feature, i) => {
        g.append("text")
            .attr("x", -10)
            .attr("y", i * cellHeight + cellHeight / 2)
            .attr("text-anchor", "end")
            .attr("dominant-baseline", "middle")
            .attr("font-size", "13px")
            .attr("font-weight", "bold")
            .text(feature);
    });
    
    const tooltip = svg.append("g")
        .style("display", "none");
    
    tooltip.append("rect")
        .attr("width", 140)
        .attr("height", 60)
        .attr("fill", "white")
        .attr("stroke", "#333")
        .attr("stroke-width", 1)
        .attr("rx", 5);
    
    const tooltipText = tooltip.append("text")
        .attr("x", 10)
        .attr("y", 20)
        .attr("font-size", "12px");
    
    const legendWidth = 120;
    const legendHeight = 300;
    const legendX = width - margin.right + 20;
    const legendY = margin.top;
    
    const legend = svg.append("g")
        .attr("transform", `translate(${legendX}, ${legendY})`);
    
    legend.append("text")
        .attr("x", 0)
        .attr("y", -10)
        .attr("font-size", "14px")
        .attr("font-weight", "bold")
        .text("Correlation");
    
    const gradientId = "correlationGradient";
    const gradient = svg.append("defs")
        .append("linearGradient")
        .attr("id", gradientId)
        .attr("x1", "0%")
        .attr("y1", "100%")
        .attr("x2", "0%")
        .attr("y2", "0%");
    
    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#d73027");
    
    gradient.append("stop")
        .attr("offset", "50%")
        .attr("stop-color", "#f7f7f7");
    
    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#4575b4");
    
    legend.append("rect")
        .attr("x", 0)
        .attr("y", 10)
        .attr("width", 25)
        .attr("height", legendHeight)
        .style("fill", `url(#${gradientId})`)
        .attr("stroke", "#333");
    
    const legendScale = d3.scaleLinear()
        .domain([1, -1])
        .range([10, legendHeight + 10]);
    
    const legendAxis = d3.axisRight(legendScale)
        .ticks(5)
        .tickFormat(d3.format(".1f"));
    
    legend.append("g")
        .attr("transform", "translate(25, 0)")
        .call(legendAxis);
    
    svg.append("text")
        .attr("x", width / 2)
        .attr("y", 30)
        .attr("text-anchor", "middle")
        .attr("font-size", "18px")
        .attr("font-weight", "bold")
        .text("Glass Dataset - Correlation Matrix");
    
    svg.append("text")
        .attr("x", width / 2)
        .attr("y", 50)
        .attr("text-anchor", "middle")
        .attr("font-size", "11px")
        .attr("fill", "#666")
        .text("Circle size = |correlation| | Color = correlation value");
    
    container.append(svg.node());
});

</script>
</body>
</html>