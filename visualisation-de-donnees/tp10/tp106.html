<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Horizontal Dot Plot with Error Bars</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial; }
    .dot { fill: #1f77b4; }
    .error-line { stroke: black; stroke-width: 2; }
    .cap { stroke: black; stroke-width: 2; }
  </style>
</head>
<body>
<div id="chart"></div>

<script>
d3.csv("iris.csv")
  .then(data => {

    const CATEGORY_COL = "species"; 
    const VALUE_COL = "sepal_length"; 

    data = data.map(d => ({
        species: d[CATEGORY_COL],
        sepal_length: +d[VALUE_COL]
    })).filter(d => d.species && !isNaN(d.sepal_length));

    const statsBySpecies = d3.group(data, d => d.species);

    const errorData = Array.from(statsBySpecies, ([species, values]) => {
      const lengths = values.map(d => d.sepal_length);
      const mean = d3.mean(lengths);
      const stdDev = d3.deviation(lengths);
      const n = lengths.length;
      const sem = stdDev / Math.sqrt(n);

      return {
        species,
        mean,
        sem,
        upper: mean + sem,
        lower: mean - sem
      };
    }).sort((a,b) => d3.ascending(a.mean,b.mean));

    const margin = {top: 30, right: 30, bottom: 50, left: 100};
    const width = 600, height = 250;
    const innerW = width - margin.left - margin.right;
    const innerH = height - margin.top - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const xScale = d3.scaleLinear()
      .domain([d3.min(errorData, d=>d.lower)*0.9, d3.max(errorData,d=>d.upper)*1.05])
      .range([0, innerW]);

    const yScale = d3.scaleBand()
      .domain(errorData.map(d=>d.species))
      .range([0, innerH])
      .padding(0.5);

    // Axes
    svg.append("g")
      .attr("transform", `translate(0,${innerH})`)
      .call(d3.axisBottom(xScale));

    svg.append("g")
      .call(d3.axisLeft(yScale));

    // X label
    svg.append("text")
      .attr("x", innerW/2)
      .attr("y", innerH + margin.bottom - 10)
      .attr("text-anchor", "middle")
      .text("Sepal Length (cm)");

    // Barres d'erreur
    const capSize = 5;
    const errorBars = svg.selectAll(".error-bar")
      .data(errorData)
      .enter()
      .append("g")
      .attr("class","error-bar")
      .attr("transform", d => `translate(0, ${yScale(d.species) + yScale.bandwidth()/2})`);

    // Ligne horizontale
    errorBars.append("line")
      .attr("x1", d=>xScale(d.lower))
      .attr("x2", d=>xScale(d.upper))
      .attr("y1",0)
      .attr("y2",0)
      .attr("class","error-line");

    // Cap gauche
    errorBars.append("line")
      .attr("x1", d=>xScale(d.lower))
      .attr("x2", d=>xScale(d.lower))
      .attr("y1",-capSize)
      .attr("y2",capSize)
      .attr("class","cap");

    // Cap droite
    errorBars.append("line")
      .attr("x1", d=>xScale(d.upper))
      .attr("x2", d=>xScale(d.upper))
      .attr("y1",-capSize)
      .attr("y2",capSize)
      .attr("class","cap");

    // Points de moyenne
    svg.selectAll(".dot")
      .data(errorData)
      .enter()
      .append("circle")
      .attr("cx", d=>xScale(d.mean))
      .attr("cy", d=>yScale(d.species) + yScale.bandwidth()/2)
      .attr("r",6)
      .attr("class","dot");

  })
  .catch(err => console.error("Erreur CSV :", err));
</script>
</body>
</html>
